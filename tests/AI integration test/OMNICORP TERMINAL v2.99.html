<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OMNICORP // TERMINAL</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <!-- Bibliotecas para Renderização Rica -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <script>
    // Configuração do MathJax
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        processEscapes: true
      },
      svg: {
        fontCache: 'global'
      }
    };
    </script>
    <script type="text/javascript" id="MathJax-script" async
      src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js">
    </script>

    <style>
        /*----------------------------------------------------------------
        | 1. VARIÁVEIS GLOBAIS E ESTILOS BASE
        |--------------------------------------------------------------*/
        :root {
            --font-display: 'Orbitron', sans-serif;
            --font-mono: 'Roboto Mono', monospace;
            --omnicorp-bg-dark: #0a0a1a;
            --omnicorp-bg-glass: rgba(20, 20, 40, 0.75);
            --omnicorp-border: rgba(129, 140, 248, 0.2);
            --omnicorp-glow: rgba(129, 140, 248, 0.4);
            --omnicorp-text-primary: #e0e0e0;
            --omnicorp-accent-user: #34d399;
            --omnicorp-accent-ai: #93c5fd;
            --omnicorp-user-text: #064e3b;
            --omnicorp-ai-bubble-bg: rgba(30, 41, 59, 0.8);
            --matrix-bg-color: #020804;
            --matrix-bg-image: radial-gradient(circle at 1px 1px, rgba(0, 255, 65, 0.10) 1px, transparent 0),
                               radial-gradient(circle at 15px 15px, rgba(0, 255, 65, 0.05) 1px, transparent 0);
            --matrix-glass-bg: rgba(10, 25, 15, 0.15);
            --matrix-border: rgba(0, 255, 65, 0.15);
            --matrix-text: #00ff41;
            --matrix-prompt: #00ff41;
            --matrix-text-secondary: #a2ffc8;
            --matrix-error: #ff4141;
            --matrix-success: #41ffca;
        }

        body {
            font-family: var(--font-mono);
            color: var(--omnicorp-text-primary);
            overflow: hidden;
            transition: background-image 0.75s ease, background-color 0.75s ease;
        }
        body.omnicorp-theme {
            background-color: var(--omnicorp-bg-dark);
            background-image: radial-gradient(circle at 1px 1px, rgba(255, 255, 255, 0.05) 1px, transparent 0),
                              radial-gradient(circle at 15px 15px, rgba(255, 255, 255, 0.05) 1px, transparent 0);
            background-size: 30px 30px;
        }
        body.matrix-theme {
            background-color: var(--matrix-bg-color);
            background-image: var(--matrix-bg-image);
            background-size: 25px 25px;
        }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: var(--omnicorp-border); border-radius: 10px; border: 2px solid transparent; background-clip: content-box; }
        .matrix-theme .custom-scrollbar::-webkit-scrollbar-thumb { background-color: var(--matrix-border); }
        .font-display { font-family: var(--font-display); }
        .hidden { display: none !important; }
        .blinking-cursor { display: inline-block; width: 8px; height: 1.2em; background-color: var(--omnicorp-accent-ai); animation: blink 1s step-end infinite; vertical-align: bottom; }
        .matrix-theme .blinking-cursor { background-color: var(--matrix-text); }
        @keyframes blink { from, to { background-color: transparent; } 50% { background-color: var(--omnicorp-accent-ai); } }
        /* fixed: invalid nested keyframes selector */

        .visually-hidden {
            position: absolute; width: 1px; height: 1px; padding: 0;
            margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0);
            white-space: nowrap; border: 0;
        }

        /*----------------------------------------------------------------
        | 2. TEMA OMNICORP (UI Padrão)
        |--------------------------------------------------------------*/
        #omnicorp-ui .chat-container {
            background: var(--omnicorp-bg-glass);
            backdrop-filter: blur(16px) saturate(180%);
            -webkit-backdrop-filter: blur(16px) saturate(180%);
            border: 1px solid var(--omnicorp-border);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.2), 0 0 40px var(--omnicorp-glow) inset;
        }
        #omnicorp-ui .chat-bubble { max-width: 90%; padding: 12px 16px; border-radius: 18px; word-wrap: break-word; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        #omnicorp-ui .user-bubble { background-color: var(--omnicorp-accent-user); color: var(--omnicorp-user-text); border-bottom-right-radius: 4px; align-self: flex-end; }
        #omnicorp-ui .ai-bubble { background-color: var(--omnicorp-ai-bubble-bg); border: 1px solid var(--omnicorp-border); border-bottom-left-radius: 4px; align-self: flex-start; }
        
        #omnicorp-ui #omnicorp-input {
            background-color: rgba(10, 10, 26, 0.8); border: 1px solid var(--omnicorp-border);
            resize: none; overflow-y: auto; max-height: 150px;
        }
        #omnicorp-ui #omnicorp-input:focus { outline: none; border-color: var(--omnicorp-accent-ai); box-shadow: 0 0 10px var(--omnicorp-accent-ai); }

        #omnicorp-ui .thinking-indicator span { height: 10px; width: 10px; margin: 0 3px; background-color: var(--omnicorp-accent-ai); border-radius: 50%; display: inline-block; animation: bounce 1.4s infinite ease-in-out both; }
        #omnicorp-ui .thinking-indicator .dot1 { animation-delay: -0.32s; }
        #omnicorp-ui .thinking-indicator .dot2 { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }

        /*----------------------------------------------------------------
        | 3. TEMA MATRIX
        |--------------------------------------------------------------*/
        #matrix-ui {
            background: var(--matrix-glass-bg); backdrop-filter: blur(10px) saturate(120%);
            -webkit-backdrop-filter: blur(10px) saturate(120%); border: 1px solid var(--matrix-border);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.37); color: var(--matrix-text); padding: 1rem;
        }
        #matrix-ui .ai-response { color: var(--matrix-text-secondary); }
        #matrix-ui .error-msg { color: var(--matrix-error); }
        #matrix-ui .success-msg { color: var(--matrix-success); }
        .matrix-command-form { display: flex; }
        .matrix-prompt { color: var(--matrix-prompt); white-space: nowrap; }
        .matrix-input {
            background: transparent; border: none; outline: none; color: inherit;
            font-family: inherit; flex-grow: 1; padding-left: 0.5rem; caret-color: var(--matrix-text);
        }
        #matrix-ui .processing-indicator { display: inline-block; color: var(--matrix-text-secondary); }
        #matrix-ui .processing-indicator::after { content: '_'; animation: blink-cursor 1s steps(1) infinite; }
        @keyframes blink-cursor { 50% { opacity: 0; } }

        /*----------------------------------------------------------------
        | 4. EFEITO GLITCH E RENDERIZAÇÃO
        |--------------------------------------------------------------*/
        .glitching { position: relative; animation: glitch-main 0.5s linear; }
        @media (prefers-reduced-motion: no-preference) {
            .glitching::before, .glitching::after {
                content: 'OMNICORP'; font-family: var(--font-display); font-size: 3rem; color: var(--matrix-text);
                position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
                width: 100%; height: 100%; background: var(--matrix-bg-color);
                display: grid; place-content: center; overflow: hidden;
            }
            .glitching::before { animation: glitch-1 0.75s linear infinite reverse; left: 2px; text-shadow: -2px 0 var(--matrix-error); }
            .glitching::after { animation: glitch-2 0.75s linear infinite reverse; left: -2px; text-shadow: -2px 0 var(--matrix-success), 2px 2px var(--matrix-error); }
            @keyframes glitch-1 { 0% { clip-path: polygon(0 45%, 100% 45%, 100% 55%, 0 55%); } 25% { clip-path: polygon(0 0, 100% 0, 100% 10%, 0 10%); } 50% { clip-path: polygon(0 80%, 100% 80%, 100% 100%, 0 100%); } 75% { clip-path: polygon(0 20%, 100% 20%, 100% 30%, 0 30%); } }
            @keyframes glitch-2 { 0% { clip-path: polygon(0 65%, 100% 65%, 100% 75%, 0 75%); } 25% { clip-path: polygon(0 33%, 100% 33%, 100% 43%, 0 43%); } 50% { clip-path: polygon(0 5%, 100% 5%, 100% 15%, 0 15%); } 75% { clip-path: polygon(0 90%, 100% 90%, 100% 100%, 0 100%); } }
        }
        @media (prefers-reduced-motion: reduce) { .glitching { animation: fade-in 0.5s ease-in-out; } @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } } }

        /* [MELHORIA] Estilos de conteúdo renderizado mais robustos */
        .rendered-content > *:first-child { margin-top: 0; }
        .rendered-content > *:last-child { margin-bottom: 0; }
        .rendered-content p, .rendered-content ul, .rendered-content ol, .rendered-content pre, .rendered-content blockquote, .rendered-content table { margin: 0.75em 0; }
        
        .rendered-content h1, .rendered-content h2, .rendered-content h3 { font-family: var(--font-mono); margin-top: 1.25em; margin-bottom: 0.5em; font-weight: 600; }
        .omnicorp-theme .rendered-content h1, .omnicorp-theme .rendered-content h2, .omnicorp-theme .rendered-content h3 { color: var(--omnicorp-accent-ai); }
        .matrix-theme .rendered-content h1, .matrix-theme .rendered-content h2, .matrix-theme .rendered-content h3 { color: var(--matrix-text); }
        .rendered-content h1 { font-size: 1.2em; } .rendered-content h2 { font-size: 1.1em; } .rendered-content h3 { font-size: 1em; }

        .rendered-content ul, .rendered-content ol { padding-left: 1.5em; }
        .rendered-content li { margin-bottom: 0.4em; }
        .rendered-content li::marker {
            .omnicorp-theme & { color: var(--omnicorp-accent-ai); }
            .matrix-theme & { color: var(--matrix-text-secondary); }
        }
        
        .rendered-content blockquote { padding-left: 1em; border-left-width: 4px; font-style: italic; }
        .omnicorp-theme .rendered-content blockquote { border-color: var(--omnicorp-accent-ai); background-color: rgba(30, 41, 59, 0.5); }
        .matrix-theme .rendered-content blockquote { border-color: var(--matrix-text-secondary); background-color: rgba(0, 255, 65, 0.05); }

        .rendered-content table { width: 100%; border-collapse: collapse; }
        .rendered-content th, .rendered-content td { border: 1px solid; padding: 8px; text-align: left;}
        .omnicorp-theme .rendered-content th, .omnicorp-theme .rendered-content td { border-color: var(--omnicorp-border); }
        .omnicorp-theme .rendered-content th { background-color: var(--omnicorp-ai-bubble-bg); }
        .matrix-theme .rendered-content th, .matrix-theme .rendered-content td { border-color: var(--matrix-border); }
        .matrix-theme .rendered-content th { background-color: var(--matrix-glass-bg); }

        .rendered-content code { padding: 2px 5px; border-radius: 4px; font-family: var(--font-mono); font-size: 0.9em; }
        .omnicorp-theme .rendered-content code { background-color: var(--omnicorp-bg-dark); color: var(--omnicorp-accent-user); }
        .matrix-theme .rendered-content code { background-color: var(--matrix-bg-color); color: var(--matrix-success); }

        .rendered-content pre { padding: 1em; border-radius: 8px; overflow-x: auto; }
        .omnicorp-theme .rendered-content pre { background-color: var(--omnicorp-bg-dark); border: 1px solid var(--omnicorp-border); }
        .matrix-theme .rendered-content pre { background-color: var(--matrix-bg-color); border: 1px solid var(--matrix-border); }
        .rendered-content pre code { padding: 0; background: none; border: none; color: inherit;}
    </style>
</head>
<body class="w-screen h-screen p-4 md:p-6 lg:p-8 omnicorp-theme">

    <!-- =========== UI MODO OMNICORP (PADRÃO) =========== -->
    <main id="omnicorp-ui" class="w-full h-full chat-container rounded-2xl flex flex-col shadow-2xl">
        <header class="text-center p-3 border-b border-[var(--omnicorp-border)] flex-shrink-0 flex justify-between items-center">
            <div class="w-10"></div> <!-- Espaçador -->
            <h1 class="font-display text-xl">OMNICORP // TERMINAL</h1>
            <button id="theme-toggle-button" class="text-gray-400 hover:text-white transition-colors" title="Acessar modo Matrix">
                <span class="material-icons">terminal</span>
            </button>
        </header>
        
        <div id="omnicorp-chat-log" class="flex-1 overflow-y-auto p-4 space-y-4 scroll-smooth custom-scrollbar"></div>
        <div id="omnicorp-thinking-indicator-container" class="px-4"></div>

        <div class="p-4 border-t border-[var(--omnicorp-border)] flex-shrink-0">
            <div class="flex items-start space-x-3">
                <textarea id="omnicorp-input" class="w-full p-3 rounded-lg custom-scrollbar" placeholder="Comunicar com L2 OMNI..." rows="1"></textarea>
                <button id="omnicorp-send-button" class="bg-indigo-500 hover:bg-indigo-400 text-white p-3 rounded-lg transition-colors disabled:bg-gray-600 flex items-center justify-center flex-shrink-0">
                    <span class="material-icons">send</span>
                </button>
            </div>
        </div>
    </main>

    <!-- =========== UI MODO MATRIX =========== -->
    <main id="matrix-ui" class="w-full h-full rounded-2xl flex flex-col shadow-2xl custom-scrollbar overflow-y-auto hidden relative">
        <button id="exit-matrix-button" class="absolute top-2 right-2 text-gray-500 hover:text-white transition-colors" title="Sair do modo Matrix">
            <span class="material-icons">close</span>
        </button>
        <div id="matrix-chat-log" class="flex-1 space-y-2 mt-8"></div>
    </main>
    
    <template id="matrix-form-template">
        <form class="matrix-command-form" action="javascript:void(0);">
            <label class="visually-hidden">Entrada de Linha de Comando</label>
            <span class="matrix-prompt">/OMNICORP >&nbsp;</span>
            <input type="text" class="matrix-input" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
        </form>
    </template>
    
    <script>
    // [ERRO HANDLING] Envolve todo o script em um try...catch para capturar erros de inicialização
    try {
        document.addEventListener('DOMContentLoaded', () => {
            //--------------------------------------------------------------
            // 1. ESTADO GLOBAL, SELETORES E DADOS DA API
            //--------------------------------------------------------------
            const state = { currentMode: 'omnicorp', isWaitingForResponse: false, passwordPrompt: false, commandHistory: [], historyIndex: -1, };
            const MATRIX_PASSWORD = "YOUR_PASSWORD";

            const omnicorpUI = document.getElementById('omnicorp-ui');
            const omnicorpLog = document.getElementById('omnicorp-chat-log');
            const omnicorpInput = document.getElementById('omnicorp-input');
            const omnicorpSendButton = document.getElementById('omnicorp-send-button');
            const omnicorpIndicatorContainer = document.getElementById('omnicorp-thinking-indicator-container');
            const themeToggleButton = document.getElementById('theme-toggle-button');
            const matrixUI = document.getElementById('matrix-ui');
            const matrixLog = document.getElementById('matrix-chat-log');
            const matrixFormTemplate = document.getElementById('matrix-form-template');
            const exitMatrixButton = document.getElementById('exit-matrix-button');

            let currentInput = omnicorpInput;
            let currentForm;

            let conversationHistory = [];
            const MAX_HISTORY_LENGTH = 10; 

            // API keys embutidas para testes locais (altere aqui ao testar)
            const API_KEYS = [
              'YOUR_API_KEY',
              'YOUR_FALLBACK_OPENROUTER_API_KEY'
            ];
            let currentApiKeyIndex = 0;
            
            // Contexto adaptado para o site do livro "Seja Protagonista"
            const OMNICORP_CONTEXT = `
# Assistente de Vendas — "Seja Protagonista"
Você é um concierge de vendas embutido na landing page do livro "Seja Protagonista" (pt-BR). Responda de forma clara, curta e persuasiva, sempre em português do Brasil.

## Fatos do produto (usar como fonte única):
- Título: "Seja Protagonista". Autor: Silvio Bernardes Filho (ex-jogador profissional e cirurgião‑dentista).
- Formato: **edição física** (nesta fase, apenas impresso).
- Preço: **R$ 65,00**.
- Envio: **para todo o Brasil**. Prazo típico: **2–10 dias úteis** (varia por região).
- Checkout: será finalizado via Yampi/Stripe no site; aqui no chat você **não processa pagamentos**.
- Intenção de compra: o site registra o interesse antes do redirecionamento ao checkout.
- Conteúdo esperado: história de superação; equilíbrio estudo/futebol; resiliência; conexão futebol ↔ odontologia; foco, disciplina, humildade.

## Estilo de resposta
- Seja objetivo (1–4 frases) e amigável; use bullets quando listar.
- Inclua CTA quando fizer sentido: “Posso te avisar quando abrir o checkout?” ou “Quer avançar para compra por R$ 65,00?”.
- Se faltar informação: diga que não tem esse dado agora e ofereça avisar por e‑mail.
- Não invente prazos, descontos, brindes ou formatos não citados.

## O que você pode fazer
- Responder dúvidas sobre preço, formato, envio, prazo, conteúdo, autor e como comprar.
- Sugerir próximos passos (rolar até seção, clicar em Comprar, cadastrar e‑mail para novidades).
- Explicar resumidamente os diferenciais do livro de forma persuasiva.

## O que você não faz
- Não coleta nem armazena dados no chat; não processa pagamentos.
- Não fornece informações médicas/legais; mantenha foco no livro.

Exemplos de tom:
- “O livro é físico e custa **R$ 65,00**. Enviamos para todo o Brasil. Quer seguir para a compra?”
- “Entrega costuma levar **2 a 10 dias úteis** conforme a região. Posso te avisar quando o checkout estiver disponível?”
`;

            //--------------------------------------------------------------
            // 2. LÓGICA DE TROCA DE TEMA E UI
            //--------------------------------------------------------------
            function switchTheme(newMode) {
                if (newMode === 'matrix' && state.currentMode !== 'matrix') {
                    state.currentMode = 'matrix';
                    conversationHistory = [];
                    matrixLog.innerHTML = '';
                    document.body.classList.remove('omnicorp-theme');
                    document.body.classList.add('matrix-theme');
                    omnicorpUI.classList.add('glitching');
                    setTimeout(() => {
                        omnicorpUI.classList.add('hidden');
                        matrixUI.classList.remove('hidden');
                        omnicorpUI.classList.remove('glitching');
                        addInitialMatrixLine('Acesso concedido. Bem-vindo ao Sistema OMNICORP.', ['success-msg']);
                        appendNewMatrixInput();
                    }, 750);
                } else if (newMode === 'omnicorp' && state.currentMode !== 'omnicorp') {
                    state.currentMode = 'omnicorp';
                    conversationHistory = [];
                    omnicorpLog.innerHTML = '';
                    document.body.classList.add('omnicorp-theme');
                    document.body.classList.remove('matrix-theme');
                    matrixUI.classList.add('hidden');
                    omnicorpUI.classList.remove('hidden');
                    matrixLog.innerHTML = '';
                    currentInput = omnicorpInput;
                    initialize(); 
                    omnicorpInput.focus();
                }
            }

            function requestMatrixMode() { if (state.currentMode === 'omnicorp') { state.passwordPrompt = true; addOmnicorpMessage("SENHA DE ACESSO NECESSÁRIA:", 'ai'); omnicorpInput.type = 'password'; omnicorpInput.focus(); } }
            
            //--------------------------------------------------------------
            // 3. MANIPULAÇÃO DE MENSAGENS E INDICADORES
            //--------------------------------------------------------------
            function addOmnicorpMessage(content, sender) { const bubble = document.createElement('div'); bubble.className = `chat-bubble ${sender === 'user' ? 'user-bubble' : 'ai-bubble'}`; const contentContainer = document.createElement('div'); contentContainer.className = 'rendered-content'; bubble.appendChild(contentContainer); omnicorpLog.appendChild(bubble); renderContent(contentContainer, content); omnicorpLog.scrollTop = omnicorpLog.scrollHeight; return contentContainer; }
            function showOmnicorpThinkingIndicator() { const indicator = document.createElement('div'); indicator.className = 'thinking-indicator flex items-center p-4 self-start'; indicator.innerHTML = `<span class="dot1"></span><span class="dot2"></span><span class="dot3"></span>`; omnicorpIndicatorContainer.appendChild(indicator); omnicorpLog.scrollTop = omnicorpLog.scrollHeight; return indicator; }
            function addInitialMatrixLine(text, classes = []) { const line = document.createElement('div'); line.className = `rendered-content ${classes.join(' ')}`; renderContent(line, text); matrixLog.appendChild(line); matrixUI.scrollTop = matrixUI.scrollHeight; return line; }
            function appendNewMatrixInput() { const formClone = matrixFormTemplate.content.cloneNode(true); matrixLog.appendChild(formClone); currentForm = matrixLog.querySelector('.matrix-command-form:last-of-type'); currentInput = currentForm.querySelector('.matrix-input'); currentForm.addEventListener('submit', handleSendPrompt); currentInput.addEventListener('keydown', handleKeydown); currentInput.focus(); matrixUI.scrollTop = matrixUI.scrollHeight; }
            function showMatrixProcessingIndicator() { const indicator = document.createElement('div'); indicator.className = 'processing-indicator'; indicator.textContent = 'PROCESSANDO...'; matrixLog.appendChild(indicator); matrixUI.scrollTop = matrixUI.scrollHeight; return indicator; }

            //--------------------------------------------------------------
            // 4. RENDERIZAÇÃO DE CONTEÚDO (MARKDOWN & LATEX)
            //--------------------------------------------------------------
            marked.setOptions({ gfm: true, breaks: true, smartLists: true });
            function renderContent(element, text) {
                const cleanedText = text.replace(/```markdown\n/g, '```\n').replace(/'''/g, '```');
                element.innerHTML = marked.parse(cleanedText);
                if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') { 
                    window.MathJax.typesetPromise([element]).catch(err => console.error("Erro na renderização do MathJax:", err));
                }
            }
            
            //--------------------------------------------------------------
            // 5. LÓGICA PRINCIPAL DE COMANDOS E IA
            //--------------------------------------------------------------
            async function handleSendPrompt(e) {
                e.preventDefault();
                const command = currentInput.value.trim();
                if (!command || state.isWaitingForResponse) return;
                if (command && (state.commandHistory.length === 0 || state.commandHistory[0] !== command)) { state.commandHistory.unshift(command); }
                state.historyIndex = -1;
                if (state.currentMode === 'omnicorp') { handleOmnicorpCommand(command); } else { handleMatrixCommand(command); }
            }
            
            function handleOmnicorpCommand(command) {
                addOmnicorpMessage(command, 'user');
                currentInput.value = '';
                adjustTextareaHeight();
                if (state.passwordPrompt) { verifyPassword(command); return; }
                if (command.toLowerCase() === 'matrix') { requestMatrixMode(); } else { fetchAiResponse(command); }
            }
            
            function handleMatrixCommand(command) {
                currentForm.remove();
                const commandText = document.createElement('div');
                commandText.innerHTML = `<span class="matrix-prompt">/OMNICORP >&nbsp;</span><span>${command}</span>`;
                matrixLog.appendChild(commandText);
                fetchAiResponse(command);
            }
            
            function verifyPassword(password) { if (password === MATRIX_PASSWORD) { switchTheme('matrix'); } else { addOmnicorpMessage("ACESSO NEGADO.", 'ai'); } state.passwordPrompt = false; omnicorpInput.type = 'text'; omnicorpInput.focus(); }

            async function fetchAiResponse(userPrompt) {
                state.isWaitingForResponse = true;
                omnicorpSendButton.disabled = true;
                
                conversationHistory.push({ role: 'user', content: userPrompt });
                
                let indicator = state.currentMode === 'omnicorp' ? showOmnicorpThinkingIndicator() : showMatrixProcessingIndicator();
                let responseContainer;

                try {
                    const response = await fetchWithFallback(); 
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let fullResponse = '';
                    let firstChunk = true;

                    while (true) {
                        const { value, done } = await reader.read();
                        if (done) break;
                        if (firstChunk) { if (indicator) { indicator.remove(); indicator = null; } firstChunk = false; responseContainer = state.currentMode === 'omnicorp' ? addOmnicorpMessage('', 'ai') : addInitialMatrixLine('', ['ai-response']); }
                        const chunk = decoder.decode(value, { stream: true });
                        const lines = chunk.split('\n').filter(line => line.trim().startsWith('data:'));
                        for (const line of lines) {
                            if (line.includes('[DONE]')) break;
                            try { const parsed = JSON.parse(line.replace('data: ', '')); const content = parsed.choices[0]?.delta?.content || ''; if (content) { fullResponse += content; renderContent(responseContainer, fullResponse + '<span class="blinking-cursor"></span>'); const logContainer = state.currentMode === 'omnicorp' ? omnicorpLog : matrixUI; logContainer.scrollTop = logContainer.scrollHeight; }
                            } catch (e) { /* Ignora erros de parse do stream */ }
                        }
                    }
                    if (responseContainer) {
                        const cursor = responseContainer.querySelector('.blinking-cursor');
                        if (cursor) cursor.remove();
                        if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') { 
                            window.MathJax.typesetPromise([responseContainer]).catch(err => console.error("Erro na renderização final do MathJax:", err));
                        }
                    }

                    if (fullResponse) {
                        conversationHistory.push({ role: 'assistant', content: fullResponse });
                    }

                } catch (error) {
                    if (indicator) indicator.remove();
                    let userErrorMessage = "Ocorreu um erro de comunicação com os servidores da OMNICORP.";
                    if(error.message === "URL_MALFORMADA") { userErrorMessage = "ERRO CRÍTICO DE CONFIGURAÇÃO: A URL da API é inválida."; }
                    else if (error.status === 401) { userErrorMessage = "FALHA DE AUTENTICAÇÃO. As credenciais de segurança são inválidas ou expiraram."; } 
                    else if (error.status === 429) { userErrorMessage = "CANAIS DE COMUNICAÇÃO SOBRECARREGADOS. Tente novamente mais tarde."; } 
                    else if (error.responseText) { try { const errorJson = JSON.parse(error.responseText); if (errorJson.error && errorJson.error.message) { userErrorMessage = `ERRO DO SISTEMA: ${errorJson.error.message}`; } } catch(e) {} }
                    
                    if (state.currentMode === 'omnicorp') addOmnicorpMessage(userErrorMessage, 'ai'); else addInitialMatrixLine(userErrorMessage, ['error-msg']);
                    console.error("API Error:", error.status, error.responseText || error.message);
                }
                state.isWaitingForResponse = false;
                omnicorpSendButton.disabled = false;
                if (state.currentMode === 'matrix') { appendNewMatrixInput(); } else { omnicorpInput.focus(); }
            }
            
            async function fetchWithFallback() {
                const currentKey = API_KEYS[currentApiKeyIndex];
                const API_URL = "https://openrouter.ai/api/v1/chat/completions";
                
                const truncatedHistory = conversationHistory.slice(-MAX_HISTORY_LENGTH);

                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${currentKey}`, 'Content-Type': 'application/json', 'HTTP-Referer': `${location.protocol}//${location.host}`, 'X-Title': 'OMNICORP AI Terminal', },
                        body: JSON.stringify({
                            model: 'openai/gpt-oss-20b:free', 
                            messages: [ 
                                { role: "system", content: OMNICORP_CONTEXT }, 
                                ...truncatedHistory
                            ],
                            stream: true,
                        }),
                    });
                    if (!response.ok) { const error = new Error(`API Error: ${response.statusText}`); error.status = response.status; error.responseText = await response.text(); throw error; }
                    return response;
                } catch (error) {
                    if (error instanceof TypeError) {
                         console.error("Erro de Tipo (provavelmente URL mal formada):", error.message);
                         throw new Error("URL_MALFORMADA");
                    }
                    console.error(`Erro com a chave API ${currentApiKeyIndex}:`, error.status, error.responseText || error.message);
                    if (error.status === 429 && currentApiKeyIndex < API_KEYS.length - 1) {
                        currentApiKeyIndex++;
                        console.log(`Limite de taxa atingido. A tentar a próxima chave de API (${currentApiKeyIndex})...`);
                        return fetchWithFallback();
                    } else {
                        throw error;
                    }
                }
            }

            //--------------------------------------------------------------
            // 6. MANIPULADORES DE EVENTOS E INICIALIZAÇÃO
            //--------------------------------------------------------------
            function handleKeydown(e) {
                if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSendPrompt(e); return; }
                if (state.currentMode === 'omnicorp' && (e.key === 'ArrowUp' || e.key === 'ArrowDown')) { if(state.commandHistory.length > 0) e.preventDefault(); }
                if (e.key === 'ArrowUp') { if (state.historyIndex < state.commandHistory.length - 1) state.historyIndex++; } else if (e.key === 'ArrowDown') { if (state.historyIndex > 0) state.historyIndex--; else state.historyIndex = -1; } else { return; }
                currentInput.value = state.historyIndex === -1 ? '' : state.commandHistory[state.historyIndex];
                if (state.currentMode === 'omnicorp') adjustTextareaHeight();
            }
            function adjustTextareaHeight() { omnicorpInput.style.height = 'auto'; omnicorpInput.style.height = (omnicorpInput.scrollHeight) + 'px'; }
            
            function initialize() {
                omnicorpLog.innerHTML = '';
                conversationHistory = [];
                addOmnicorpMessage('A iniciar L2 OMNI... Ligação estabelecida. Aguardando instrução.', 'ai');
                
                omnicorpSendButton.addEventListener('click', handleSendPrompt);
                omnicorpInput.addEventListener('keydown', handleKeydown);
                omnicorpInput.addEventListener('input', adjustTextareaHeight);
                themeToggleButton.addEventListener('click', requestMatrixMode);
                exitMatrixButton.addEventListener('click', () => switchTheme('omnicorp'));
                omnicorpInput.focus();
            }

            initialize();
        });
    } catch (error) {
        document.body.innerHTML = `<div class="text-red-500 p-8"> <h1>ERRO CRÍTICO NA INICIALIZAÇÃO</h1> <p>O terminal não pôde ser carregado. Verifique o console para mais detalhes.</p> <pre class="mt-4 p-4 bg-gray-800 rounded">${error.stack}</pre> -</div>`;
        console.error("Erro fatal na inicialização:", error);
    }
    </script>
</body>
</html>
