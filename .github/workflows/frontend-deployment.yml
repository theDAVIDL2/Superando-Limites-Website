name: Frontend Deployment

on:
  push:
    branches:
      - main
    paths:
      - 'frontend/**'
      - '!frontend/README.md'
      - '!frontend/docs/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  build-and-deploy:
    name: ðŸŽ¨ Build & Deploy Frontend
    runs-on: ubuntu-latest
    
    environment:
      name: production-frontend
      url: https://your-frontend-url.com

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: ðŸ” Cache frontend dependencies
        uses: actions/cache@v4
        with:
          path: |
            frontend/node_modules
            ~/.npm
          key: ${{ runner.os }}-frontend-${{ hashFiles('frontend/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-frontend-

      - name: ðŸ”§ Install dependencies
        working-directory: frontend
        run: npm ci --prefer-offline --no-audit

      - name: ðŸ—ï¸ Build frontend
        working-directory: frontend
        run: npm run build
        env:
          NODE_ENV: production
          GENERATE_SOURCEMAP: false
          INLINE_RUNTIME_CHUNK: false
          REACT_APP_API_URL: ${{ secrets.REACT_APP_API_URL }}
          REACT_APP_ENV: production

      - name: âœ… Build successful
        run: |
          echo "âœ… Frontend built successfully!"
          echo "ðŸ“¦ Build size: $(du -sh frontend/build | cut -f1)"
          echo "ðŸ“ Files: $(find frontend/build -type f | wc -l)"
          echo ""
          echo "Build contents:"
          ls -lah frontend/build/

      - name: ðŸ§ª Run tests (if available)
        working-directory: frontend
        run: |
          if [ -f "package.json" ] && grep -q '"test"' package.json; then
            npm test -- --watchAll=false --passWithNoTests || echo "No tests found or tests skipped"
          else
            echo "No test script found, skipping tests"
          fi

      - name: ðŸ’¾ Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build-${{ github.sha }}
          path: frontend/build
          retention-days: 7
          compression-level: 9

      - name: ðŸ“ Create deployment record
        uses: actions/github-script@v7
        with:
          script: |
            try {
              const deployment = await github.rest.repos.createDeployment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: context.sha,
                environment: 'production-frontend',
                description: 'Frontend deployment',
                auto_merge: false,
                required_contexts: [],
                production_environment: true
              });
              
              await github.rest.repos.createDeploymentStatus({
                owner: context.repo.owner,
                repo: context.repo.repo,
                deployment_id: deployment.data.id,
                state: 'success',
                log_url: `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
                description: 'Frontend deployed successfully',
                environment_url: 'https://your-frontend-url.com'
              });
              
              console.log('âœ… Deployment tracked successfully');
            } catch (error) {
              console.error('âš ï¸ Failed to track deployment:', error.message);
            }

      - name: ðŸ“Š Summary
        run: |
          echo "## ðŸŽ‰ Frontend Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Build completed successfully" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ Artifact uploaded" >> $GITHUB_STEP_SUMMARY
          echo "ðŸš€ Ready for deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "- Download artifact from Actions tab" >> $GITHUB_STEP_SUMMARY
          echo "- Or run deployment script: \`deploy-hostinger.bat\`" >> $GITHUB_STEP_SUMMARY
          echo "- Or push to Netlify/Vercel" >> $GITHUB_STEP_SUMMARY

  # Optional: Auto-deploy to Netlify (if configured)
  deploy-netlify:
    name: ðŸš€ Deploy to Netlify
    runs-on: ubuntu-latest
    needs: build-and-deploy
    if: github.event_name == 'push'
    
    steps:
      - name: ðŸ“¥ Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-build-${{ github.sha }}
          path: build

      - name: ðŸš€ Deploy to Netlify
        uses: nwtgck/actions-netlify@v3.0
        with:
          publish-dir: './build'
          production-branch: main
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: "Deploy from GitHub Actions"
          enable-pull-request-comment: false
          enable-commit-comment: false
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        if: env.NETLIFY_AUTH_TOKEN != '' && env.NETLIFY_SITE_ID != ''

